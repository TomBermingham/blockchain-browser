<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Blockchain browser</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <style>
        body {
            height: 100vh;
            overflow: hidden;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0px;
        }
        body > header {
            top: 0; width: 100%;
            height: 30px;
            border-bottom: 1px solid lightgray;
            font-size: 20px;
            display: flex;
            padding: 3px;
        }
        main {
            overflow: none;
            height: calc(100vh - 37px);
            /*padding: 0px 10px;*/
        }
        main > article {
            padding-bottom: 15px;
        }
        body > header > button {
            font-size: 18px;
            vertical-align: middle;
            padding: 0px 4px 0px 4px;
            border-width: 0px;
            background-color: white;
            border-radius: 10px;
        }
        body > header > button:hover {
            background-color: #F1F3F4;
            cursor: pointer;
        }
        body > header > form {
            display: flex;
            height: 100%;
        }
        body > header > form > input {
            width: 60vw;
            font-size: 16px;
            border-radius: 10px;
            border-width: 0px;
            background-color: #F1F3F4;
            color: #202124;
            padding: 0px 10px 0px 10px;
            margin: 2px 6px 2px 6px;
        }
        body > header > form > input:focus {
            background-color: white;
        }
        #main-newwebsite {
            margin: 60px;
        }
        #newwebsite > textarea {
            width: 100%;
            height: 150px;
            padding: 3px;
            box-sizing: border-box;
            border: 2px solid #ccc;
            border-radius: 4px;
            background-color: #f8f8f8;
            font-size: 16px;
            resize: none;
        }
        #newwebsite > button {
            background-color: blue;
            color: white;
            border: none;
            border-radius: 4px;
            width: 100%;
            height: 30px;
        }
        #newwebsite > input {
            border-radius: 4px;
            border: 2px solid #ccc;
            width: 100%;
            background-color: #F9F9F9;
            box-sizing: border-box;
            font-size: 16px;
            padding: 3px;
        }
        #newwebsite > label {
            display: block;
        }
        iframe {
            width: 100%;
            height: 100%;
            border-width: 0px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
</head>

<body>
    <header>
        <button onclick="history.back()">&#x2190;</button>
        <button onclick="history.forward()">&#x2192;</button>
        <button onclick="window.location.href = './?address=welcome.eth'">&#x1F3E0;</button>
        <form id="navigate">
            <input autocomplete="on" autocorrect="off" autocapitalize="none" type="text" id="url" onclick="this.setSelectionRange(0, this.value.length)"/>
        </form>
    </header>
    <main id="page">
        <iframe id="content" src="about:blank"></iframe>
    </main>

    <script>
        const web3 = new Web3(new Web3.providers.HttpProvider('https://eth-sepolia.g.alchemy.com/v2/m41vG11L6gyJJ5QkkqcU5UuG_FfCpWVc'));

        const abiWebsite = [
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "oldOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnerSet",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "changeOwner",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_html",
                        "type": "string"
                    }
                ],
                "name": "deploy",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_html",
                        "type": "string"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "getOwner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "retrieve",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ]

        const abiDnsFull = [
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_domain",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "_html",
                        "type": "string"
                    }
                ],
                "name": "createSite",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_domain",
                        "type": "string"
                    }
                ],
                "name": "remove",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_addr",
                        "type": "address"
                    },
                    {
                        "internalType": "string",
                        "name": "_domain",
                        "type": "string"
                    }
                ],
                "name": "set",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "name": "addresses",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_domain",
                        "type": "string"
                    }
                ],
                "name": "get",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_domain",
                        "type": "string"
                    }
                ],
                "name": "getSite",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "list",
                "outputs": [
                    {
                        "internalType": "string[]",
                        "name": "",
                        "type": "string[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ]

        //DNS 1 0xf47FcbC691C60190a32e8f64ccD6d64a5eA7621c
        //DNS 2 0x7DF890c9D449707c8139e802f1299310e62d6448
        const DNS = '0x7DF890c9D449707c8139e802f1299310e62d6448';

        const nav = document.querySelector('#navigate');
        nav.addEventListener('submit', event => {
            event.preventDefault();
            const address = event.target[0].value;
            window.location.href = './?address=' + address
        });

        const loadPage = async (address) => {
            console.log("Navigating to:" + address);
            let html = '';

            if(address.includes('.')){
                try {
                    html = await lookupSite(address);
                } catch (error) {
                    const hex = await lookupDomain(address);
                    if(hex === '0x0000000000000000000000000000000000000000'){
                        console.log('Domain not found');
                        const newWebsiteHTML = `<main id="main-newwebsite" class="container"><hgroup>
                <h1>New website</h1>
                <h2>Create your own website on the blockchain.</h2>
            </hgroup>
            <form id="newwebsite">
                <label for="domain">Domain</label>
                <input type="text" id="domain" required value="${address}"/>
                <label for="html">HTML</label>
                <textarea id="html" required></textarea>
                <button aria-busy="false" role="submit" id="create">Create</button>
            </form></main>`
                        document.getElementById('page').innerHTML = newWebsiteHTML;
                        document.getElementById('domain').innerText = address;

                        const form = document.getElementById("newwebsite");
                        form.addEventListener("submit", (event) => {
                            event.preventDefault();
                            const domain = event.target[0].value;
                            const html = event.target[1].value;
                            console.log('Deploy\n' + domain + '\n' + html)
                            createSite(domain, html);
                        });
                        return;
                    }
                }
            } else {
                html = await getHTML(address);
            }

            document.getElementById('content').srcdoc = html;

            //Sanitise
            document.getElementById('content').onload = (event) => {
                const links = document.getElementById('content').contentDocument.querySelectorAll('a');
                for ( let c = 0; c < links.length; c ++ ) {
                    links[c].addEventListener('click', (e) => {
                        /*if(!e.target.href.includes('http://127.0.0.1')) {
                            console.log('Blocked');
                            e.preventDefault();
                            return;
                        }*/
                        window.location.href = e.target.href;
                        e.preventDefault();
                    });
                }
            }
        }

        const lookupDomain = async (domain) => {
            const res = await call('get', DNS, abiDnsFull, [domain]);
            return res;
        }

        const lookupSite = async (domain) => {
            const res = await call('getSite', DNS, abiDnsFull, [domain]);
            return res;
        }

        const createSite = async (domain, html) => {
            document.getElementById('create').setAttribute("aria-busy", "true");
            document.getElementById('create').innerText = '...';
            document.getElementById('create').disabled = true;

            const receipt = await signedCall('createSite', DNS, abiDnsFull, [domain, html]);

            document.getElementById('create').setAttribute("aria-busy", "false"); 
            console.log(`Deployed: ${domain}`);
            const newWebsiteAddress = "./?address=" + domain;
            window.location.href = newWebsiteAddress;
            return true;
        }

        const list = async () => {
            const res = await call('list', DNS, abiDnsFull, []);
            return res;
        }

        const getHTML = async (address) => {
            const res = await call('retrieve', address, abiWebsite, []);
            return res;
        }

        async function call(method, address, abi, parameters) {
            const contract = new web3.eth.Contract(abi, address);
            const tx = await contract.methods[method](...parameters);
            const res = await tx.call({from: '0xFda4d8e621a7De536B67226Ab33029D48c26e823'});
            return res;
        }

        async function signedCall(method, address, abi, parameters) {
            const contract = new web3.eth.Contract(abi, address);
            const tx = await contract.methods[method](...parameters);

            const estimate = await tx.estimateGas();
            console.log(`Estimate: ${estimate}`);
            const gasPrice = await web3.eth.getGasPrice();
            console.log(`Gas price: ${gasPrice}`);
            
            const signedTransaction = await web3.eth.accounts.signTransaction(
                {
                    from: '0xFda4d8e621a7De536B67226Ab33029D48c26e823',
                    to: address,
                    gasPrice: Math.floor(gasPrice * 1.1),
                    data: tx.encodeABI(),
                    gas: estimate * 2
                },
                ''
            );
            
            const receipt = await web3.eth.sendSignedTransaction(signedTransaction.rawTransaction);
            return receipt;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const addr = urlParams.get('address');
        document.getElementById('url').value = addr;
        if (addr) loadPage(addr);

        const bytecode = "0x60806040523480156200001157600080fd5b5060405162000fc138038062000fc18339818101604052810190620000379190620002a1565b33600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167f342827c97908e5e2f71151c08502a66d44b6f758e3ac2f1de95f02eb95f0a73560405160405180910390a380600090816200010691906200053d565b505062000624565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b62000177826200012c565b810181811067ffffffffffffffff821117156200019957620001986200013d565b5b80604052505050565b6000620001ae6200010e565b9050620001bc82826200016c565b919050565b600067ffffffffffffffff821115620001df57620001de6200013d565b5b620001ea826200012c565b9050602081019050919050565b60005b8381101562000217578082015181840152602081019050620001fa565b60008484015250505050565b60006200023a6200023484620001c1565b620001a2565b90508281526020810184848401111562000259576200025862000127565b5b62000266848285620001f7565b509392505050565b600082601f83011262000286576200028562000122565b5b81516200029884826020860162000223565b91505092915050565b600060208284031215620002ba57620002b962000118565b5b600082015167ffffffffffffffff811115620002db57620002da6200011d565b5b620002e9848285016200026e565b91505092915050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200034557607f821691505b6020821081036200035b576200035a620002fd565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620003c57fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000386565b620003d1868362000386565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b60006200041e620004186200041284620003e9565b620003f3565b620003e9565b9050919050565b6000819050919050565b6200043a83620003fd565b62000452620004498262000425565b84845462000393565b825550505050565b600090565b620004696200045a565b620004768184846200042f565b505050565b5b818110156200049e57620004926000826200045f565b6001810190506200047c565b5050565b601f821115620004ed57620004b78162000361565b620004c28462000376565b81016020851015620004d2578190505b620004ea620004e18562000376565b8301826200047b565b50505b505050565b600082821c905092915050565b60006200051260001984600802620004f2565b1980831691505092915050565b60006200052d8383620004ff565b9150826002028217905092915050565b6200054882620002f2565b67ffffffffffffffff8111156200056457620005636200013d565b5b6200057082546200032c565b6200057d828285620004a2565b600060209050601f831160018114620005b55760008415620005a0578287015190505b620005ac85826200051f565b8655506200061c565b601f198416620005c58662000361565b60005b82811015620005ef57848901518255600182019150602085019450602081019050620005c8565b868310156200060f57848901516200060b601f891682620004ff565b8355505b6001600288020188555050505b505050505050565b61098d80620006346000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c80632e64cec114610051578063893d20e81461006f578063a6f9dae11461008d578063c7602316146100a9575b600080fd5b6100596100c5565b6040516100669190610374565b60405180910390f35b610077610157565b60405161008491906103d7565b60405180910390f35b6100a760048036038101906100a29190610432565b610181565b005b6100c360048036038101906100be9190610594565b6102d1565b005b6060600080546100d49061060c565b80601f01602080910402602001604051908101604052809291908181526020018280546101009061060c565b801561014d5780601f106101225761010080835404028352916020019161014d565b820191906000526020600020905b81548152906001019060200180831161013057829003601f168201915b5050505050905090565b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610211576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610208906106af565b60405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f342827c97908e5e2f71151c08502a66d44b6f758e3ac2f1de95f02eb95f0a73560405160405180910390a380600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b80600090816102e09190610885565b5050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561031e578082015181840152602081019050610303565b60008484015250505050565b6000601f19601f8301169050919050565b6000610346826102e4565b61035081856102ef565b9350610360818560208601610300565b6103698161032a565b840191505092915050565b6000602082019050818103600083015261038e818461033b565b905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006103c182610396565b9050919050565b6103d1816103b6565b82525050565b60006020820190506103ec60008301846103c8565b92915050565b6000604051905090565b600080fd5b600080fd5b61040f816103b6565b811461041a57600080fd5b50565b60008135905061042c81610406565b92915050565b600060208284031215610448576104476103fc565b5b60006104568482850161041d565b91505092915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6104a18261032a565b810181811067ffffffffffffffff821117156104c0576104bf610469565b5b80604052505050565b60006104d36103f2565b90506104df8282610498565b919050565b600067ffffffffffffffff8211156104ff576104fe610469565b5b6105088261032a565b9050602081019050919050565b82818337600083830152505050565b6000610537610532846104e4565b6104c9565b90508281526020810184848401111561055357610552610464565b5b61055e848285610515565b509392505050565b600082601f83011261057b5761057a61045f565b5b813561058b848260208601610524565b91505092915050565b6000602082840312156105aa576105a96103fc565b5b600082013567ffffffffffffffff8111156105c8576105c7610401565b5b6105d484828501610566565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061062457607f821691505b602082108103610637576106366105dd565b5b50919050565b7f43616c6c6572206973206e6f7420746865206f776e6572206f6620746869732060008201527f7765627369746500000000000000000000000000000000000000000000000000602082015250565b60006106996027836102ef565b91506106a48261063d565b604082019050919050565b600060208201905081810360008301526106c88161068c565b9050919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026107317fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826106f4565b61073b86836106f4565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600061078261077d61077884610753565b61075d565b610753565b9050919050565b6000819050919050565b61079c83610767565b6107b06107a882610789565b848454610701565b825550505050565b600090565b6107c56107b8565b6107d0818484610793565b505050565b5b818110156107f4576107e96000826107bd565b6001810190506107d6565b5050565b601f8211156108395761080a816106cf565b610813846106e4565b81016020851015610822578190505b61083661082e856106e4565b8301826107d5565b50505b505050565b600082821c905092915050565b600061085c6000198460080261083e565b1980831691505092915050565b6000610875838361084b565b9150826002028217905092915050565b61088e826102e4565b67ffffffffffffffff8111156108a7576108a6610469565b5b6108b1825461060c565b6108bc8282856107f8565b600060209050601f8311600181146108ef57600084156108dd578287015190505b6108e78582610869565b86555061094f565b601f1984166108fd866106cf565b60005b8281101561092557848901518255600182019150602085019450602081019050610900565b86831015610942578489015161093e601f89168261084b565b8355505b6001600288020188555050505b50505050505056fea26469706673582212206e64db31c38b3a7070ef381d003ddf6cecd1087e0f5cebf2fce8e0d7c466b00f64736f6c63430008120033";
    </script>
</body>

</html>
